import torch

# copy pasted from https://github.com/yushuang-wu/NeRDF/blob/main/utils/spherical_harmonics.py

def embed_spherical_harmonics(dirs: torch.Tensor, degree=8) -> torch.Tensor:
    """
    Embeds the input directions into the spherical harmonics space.
    Args:
        dirs (torch.Tensor): The input directions [N_rays, 3].
        degree (int): The degree of the spherical harmonics. Default is 8.
    Returns:
        torch.Tensor: The embedded directions [N_rays, 8].
    """
    x, y, z = dirs[:, 0], dirs[:, 1], dirs[:, 2]
    xy, xz, yz = x * y, x * z, y * z
    x2, y2, z2 = x * x, y * y, z * z
    x4, y4, z4 = x2 * x2, y2 * y2, z2 * z2
    x6, y6, z6 = x4 * x2, y4 * y2, z4 * z2

    N_rays = x.shape[0]
    embedding = torch.zeros([N_rays, 64]).float()

    embedding[:, 0] = 0.28209479177387814
    embedding[:, 1] = -0.48860251190291987 * y
    embedding[:, 2] = 0.48860251190291987 * z
    embedding[:, 3] = -0.48860251190291987 * x

    embedding[:, 4] = 1.0925484305920792 * xy
    embedding[:, 5] = -1.0925484305920792 * yz
    embedding[:, 6] = 0.94617469575755997 * z2 - 0.31539156525251999
    embedding[:, 7] = -1.0925484305920792 * xz
    embedding[:, 8] = 0.54627421529603959 * x2 - 0.54627421529603959 * y2

    embedding[:, 9] = 0.59004358992664352 * y * (-3.0 * x2 + y2)
    embedding[:, 10] = 2.8906114426405538 * xy * z
    embedding[:, 11] = 0.45704579946446572 * y * (1.0 - 5.0 * z2)
    embedding[:, 12] = 0.37317633259011540 * z * (5.0 * z2 - 3.0)
    embedding[:, 13] = 0.45704579946446572 * x * (1.0 - 5.0 * z2)
    embedding[:, 14] = 1.4453057213202769 * z * (x2 - y2)
    embedding[:, 15] = 0.59004358992664352 * x * (-x2 + 3.0 * y2)

    embedding[:, 16] = 0.59004358992664352 * x * (-x2 + 3.0 * y2)
    embedding[:, 17] = 1.7701307697799304 * yz * (-3.0 * x2 + y2)
    embedding[:, 18] = 0.94617469575756008 * xy * (7.0 * z2 - 1.0)
    embedding[:, 19] = 0.66904654355728921 * yz * (3.0 - 7.0 * z2)
    embedding[:, 20] = (
        -3.1735664074561294 * z2 + 3.7024941420321507 * z4 + 0.31735664074561293
    )
    embedding[:, 21] = 0.66904654355728921 * xz * (3.0 - 7.0 * z2)
    embedding[:, 22] = 0.47308734787878004 * (x2 - y2) * (7.0 * z2 - 1.0)
    embedding[:, 23] = 1.7701307697799304 * xz * (-x2 + 3.0 * y2)
    embedding[:, 24] = (
        -3.7550144126950569 * x2 * y2
        + 0.62583573544917614 * x4
        + 0.62583573544917614 * y4
    )

    embedding[:, 25] = 0.65638205684017015 * y * (10.0 * x2 * y2 - 5.0 * x4 - y4)
    embedding[:, 26] = 8.3026492595241645 * xy * z * (x2 - y2)
    embedding[:, 27] = -0.48923829943525038 * y * (3.0 * x2 - y2) * (9.0 * z2 - 1.0)
    embedding[:, 28] = 4.7935367849733241 * xy * z * (3.0 * z2 - 1.0)
    embedding[:, 29] = 0.45294665119569694 * y * (14.0 * z2 - 21.0 * z4 - 1.0)
    embedding[:, 30] = 0.11695032245342360 * z * (-70.0 * z2 + 63.0 * z4 + 15.0)
    embedding[:, 31] = 0.45294665119569694 * x * (14.0 * z2 - 21.0 * z4 - 1.0)
    embedding[:, 32] = 2.3967683924866621 * z * (x2 - y2) * (3.0 * z2 - 1.0)
    embedding[:, 33] = -0.48923829943525038 * x * (x2 - 3.0 * y2) * (9.0 * z2 - 1.0)
    embedding[:, 34] = 2.0756623148810411 * z * (-6.0 * x2 * y2 + x4 + y4)
    embedding[:, 35] = 0.65638205684017015 * x * (10.0 * x2 * y2 - x4 - 5.0 * y4)

    embedding[:, 36] = 1.3663682103838286 * xy * (-10.0 * x2 * y2 + 3.0 * x4 + 3.0 * y4)
    embedding[:, 37] = 2.3666191622317521 * yz * (10.0 * x2 * y2 - 5.0 * x4 - y4)
    embedding[:, 38] = 2.0182596029148963 * xy * (x2 - y2) * (11.0 * z2 - 1.0)
    embedding[:, 39] = -0.92120525951492349 * yz * (3.0 * x2 - y2) * (11.0 * z2 - 3.0)
    embedding[:, 40] = 0.92120525951492349 * xy * (-18.0 * z2 + 33.0 * z4 + 1.0)
    embedding[:, 41] = 0.58262136251873131 * yz * (30.0 * z2 - 33.0 * z4 - 5.0)
    embedding[:, 42] = (
        6.6747662381009842 * z2
        - 20.024298714302954 * z4
        + 14.684485723822165 * z6
        - 0.31784601133814211
    )
    embedding[:, 43] = 0.58262136251873131 * xz * (30.0 * z2 - 33.0 * z4 - 5.0)
    embedding[:, 44] = (
        0.46060262975746175
        * (x2 - y2)
        * (11.0 * z2 * (3.0 * z2 - 1.0) - 7.0 * z2 + 1.0)
    )
    embedding[:, 45] = -0.92120525951492349 * xz * (x2 - 3.0 * y2) * (11.0 * z2 - 3.0)
    embedding[:, 46] = (
        0.50456490072872406 * (11.0 * z2 - 1.0) * (-6.0 * x2 * y2 + x4 + y4)
    )
    embedding[:, 47] = 2.3666191622317521 * xz * (10.0 * x2 * y2 - x4 - 5.0 * y4)
    embedding[:, 48] = (
        10.247761577878714 * x2 * y4
        - 10.247761577878714 * x4 * y2
        + 0.6831841051919143 * x6
        - 0.6831841051919143 * y6
    )

    embedding[:, 49] = (
        0.70716273252459627 * y * (-21.0 * x2 * y4 + 35.0 * x4 * y2 - 7.0 * x6 + y6)
    )
    embedding[:, 50] = (
        5.2919213236038001 * xy * z * (-10.0 * x2 * y2 + 3.0 * x4 + 3.0 * y4)
    )
    embedding[:, 51] = (
        -0.51891557872026028 * y * (13.0 * z2 - 1.0) * (-10.0 * x2 * y2 + 5.0 * x4 + y4)
    )
    embedding[:, 52] = 4.1513246297620823 * xy * z * (x2 - y2) * (13.0 * z2 - 3.0)
    embedding[:, 53] = (
        -0.15645893386229404
        * y
        * (3.0 * x2 - y2)
        * (13.0 * z2 * (11.0 * z2 - 3.0) - 27.0 * z2 + 3.0)
    )
    embedding[:, 54] = 0.44253269244498261 * xy * z * (-110.0 * z2 + 143.0 * z4 + 15.0)
    embedding[:, 55] = (
        0.090331607582517306 * y * (-135.0 * z2 + 495.0 * z4 - 429.0 * z6 + 5.0)
    )
    embedding[:, 56] = (
        0.068284276912004949 * z * (315.0 * z2 - 693.0 * z4 + 429.0 * z6 - 35.0)
    )
    embedding[:, 57] = (
        0.090331607582517306 * x * (-135.0 * z2 + 495.0 * z4 - 429.0 * z6 + 5.0)
    )
    embedding[:, 58] = (
        0.07375544874083044
        * z
        * (x2 - y2)
        * (143.0 * z2 * (3.0 * z2 - 1.0) - 187.0 * z2 + 45.0)
    )
    embedding[:, 59] = (
        -0.15645893386229404
        * x
        * (x2 - 3.0 * y2)
        * (13.0 * z2 * (11.0 * z2 - 3.0) - 27.0 * z2 + 3.0)
    )
    embedding[:, 60] = (
        1.0378311574405206 * z * (13.0 * z2 - 3.0) * (-6.0 * x2 * y2 + x4 + y4)
    )
    embedding[:, 61] = (
        -0.51891557872026028 * x * (13.0 * z2 - 1.0) * (-10.0 * x2 * y2 + x4 + 5.0 * y4)
    )
    embedding[:, 62] = 2.6459606618019 * z * (15.0 * x2 * y4 - 15.0 * x4 * y2 + x6 - y6)
    embedding[:, 63] = (
        0.70716273252459627 * x * (-35.0 * x2 * y4 + 21.0 * x4 * y2 - x6 + 7.0 * y6)
    )

    dim = [1, 4, 9, 16, 25, 36, 49, 64][degree - 1]
    return embedding[:, :dim]
